This Product Requirements Document (PRD) outlines the transition from a manual, error-prone PDF math workflow to a real-time, collaborative ecosystem. It leverages **Next.js**, **Convex**, and **Tiptap** to ensure that solutions for complex topics—like Laplace transforms and spring systems—are dynamic and community-verified.

---

# PRD: Collaborative Math Platform (CMP)

## 1. Project Vision

To eliminate the "PDF re-download cycle" by providing a single source of truth for math assignments where students, TAs, and professors can identify, dispute, and correct errors in real-time with full version transparency.

---

## 2. User Roles & Permissions Matrix

The platform utilizes a granular permissions system. A Professor can customize these for any user in the **Member Management** view.

| Permission | Student | Teaching Assistant (TA) | Professor |
| --- | --- | --- | --- |
| **View Assignments** | ✅ | ✅ | ✅ |
| **Open/Comment on Dispute** | ✅ | ✅ | ✅ |
| **Edit Master Solution** | ❌ | ✅ (Configurable) | ✅ |
| **Resolve/Dismiss Dispute** | ❌ | ✅ | ✅ |
| **Manage Roster/Permissions** | ❌ | ❌ | ✅ |
| **Revert Edits (Audit Log)** | ❌ | ❌ | ✅ |

---

## 3. Functional Requirements

### 3.1 Hierarchical Class Structure

* **Organization:** Assignments must be nested under **Year > Semester > Class**.
* **Access:** Students join via a unique **Invite Code** generated by the professor.
* **Management:** Professors can revoke access or modify permissions for any user in the roster.

### 3.2 AI-Powered Tiptap Upload

* 
**PDF Parsing:** The system ingests problem sets and answer keys (e.g., `24_HW_4C.pdf`).


* 
**Tiptap Integration:** Solutions are converted into a series of **Tiptap JSON nodes** using the `Mathematics` extension for LaTeX rendering.


* 
**Segmentation:** Each logical step (e.g., "Step 1: Setup DE," "Step 2: Laplace Transform") becomes an independent `SolutionLine`.



### 3.3 The Dispute & Sidebar System

* 
**Line-Level Disputes:** Students can flag a specific line (e.g., a sign error in a partial fraction).


* **Sidebar Interactions:** Clicking a flagged line animates a sidebar containing a thread of comments and reactions (thumbs up/down).
* **In-Place Editing:** TAs and Professors can edit the Tiptap node directly within the sidebar to resolve a dispute.

### 3.4 Audit Logs & Reversion

* **Logged Updates:** Every change to a `SolutionLine` creates an entry in the **AuditLogs** table.
* **Version History:** Professors can view a "diff" of the math JSON.
* **Revert:** Professors can overwrite the current state with a previous version from the log.

---

## 4. Technical Specifications

### 4.1 Tech Stack

* **Frontend:** Next.js (App Router), TypeScript, Tailwind CSS, Shadcn/UI.
* **Real-time Backend/DB:** Convex.
* **Editor:** Tiptap with `Mathematics` (KaTeX) and `StarterKit`.

### 4.2 Database Schema (Convex `schema.ts`)

The schema is designed to store Tiptap's structured JSON to allow for partial document updates and versioning.

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  users: defineTable({
    name: v.string(),
    email: v.string(),
    role: v.string(), // "admin" | "user"
  }),
  classes: defineTable({
    name: v.string(),
    semester: v.string(),
    year: v.number(),
    inviteCode: v.string(),
    professorId: v.id("users"),
  }),
  classMembers: defineTable({
    classId: v.id("classes"),
    userId: v.id("users"),
    role: v.string(), // "professor" | "ta" | "student"
    permissions: v.array(v.string()), // e.g., ["edit_solution", "resolve_dispute"]
    status: v.string(), // "active" | "revoked"
  }),
  solutionLines: defineTable({
    problemId: v.id("problems"),
    contentJson: v.any(), // Tiptap JSON fragment
    order: v.number(),
    isCorrected: v.boolean(),
  }),
  disputes: defineTable({
    lineId: v.id("solutionLines"),
    status: v.string(), // "pending" | "resolved" | "dismissed"
    creatorId: v.id("users"),
  }),
  auditLogs: defineTable({
    classId: v.id("classes"),
    lineId: v.id("solutionLines"),
    editorId: v.id("users"),
    oldContentJson: v.any(),
    newContentJson: v.any(),
    timestamp: v.number(),
  }),
});

```

---

## 5. Page Sitemap & User Flows

### 5.1 Admin/Professor Pages

1. **Global Dashboard:** Overview of classes and a "Critical Disputes" feed.
2. **Audit Log Viewer:** High-level stream of all changes with "Revert" functionality.
3. **Member & Permissions Manager:** Table of users with toggle switches for specific permissions.
4. **Upload Studio:** Multi-step wizard for PDF upload and AI verification.

### 5.2 Student/Consumer Pages

1. **Course Dashboard:** View assignments for the current semester.
2. 
**Assignment Workspace:** List view of problems (e.g., Problem 1a, 2a).


3. **Interactive Solution View:** The primary workspace for studying and disputing.

---

## 6. Notification Logic

* **Student Action:** Student disputes a line  Notification to Professor/TAs.
* **TA Action:** TA updates line  Notification to the student who disputed.
* 
**Resolution:** Line marked as "Corrected"  Global notification to the class: *"Correction: HW 4C, Prob 1a updated"*.


## app file structure 

```
/app
├── layout.tsx                 # Root layout with ConvexProvider and Shadcn Toaster
├── page.tsx                   # Landing page / Role-based redirect logic
│
├── (auth)                     # Authentication Route Group
│   ├── login/page.tsx
│   └── register/page.tsx
│
├── dashboard/                 # Shared Global Dashboard
│   ├── layout.tsx             # Sidebar with "Years" and "Semesters" navigation
│   └── page.tsx               # Cards for all enrolled/teaching classes
│
├── classes/                   # Dynamic Class Routes
│   └── [classId]/
│       ├── layout.tsx         # Class-specific header (Invite code, Class Name)
│       ├── page.tsx           # Assignment Feed (List of published HW)
│       │
│       ├── roster/            # Professor/TA Member & Permissions Management
│       │   └── page.tsx       # Data-table with Revoke/Permission switches
│       │
│       ├── audit-logs/        # Professor Version Control/Revert Page
│       │   └── page.tsx       # Scroll-area with Tiptap JSON diffs and Revert buttons
│       │
│       ├── assignments/       # Assignment Context
│       │   └── [assignmentId]/
│       │       ├── page.tsx   # List view of individual Problem Statements
│       │       └── problems/
│       │           └── [problemId]/
│       │               └── page.tsx # CORE PAGE: Problem Statement + Tiptap Solution Lines
│       │
│       └── upload/            # Professor-only Upload Studio
│           └── page.tsx       # Multi-step wizard: PDF Ingestion -> AI Preview -> Tiptap Sync
│
├── notifications/             # Global Notification Center
│   └── page.tsx               # Inbox for New Disputes, Corrections, and Assignments
│
└── api/                       # API Routes (for heavy PDF/AI processing)
    └── ai-parse/
        └── route.ts           # Receives PDF, sends to AI, returns Tiptap JSON fragments

```